{% extends 'base.html' %}
{% load static %}

{% block title %}å ±è¡¨ç”Ÿæˆ - Datanalyze{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'Datanalyze/css/main.css' %}">
<link rel="stylesheet" href="{% static 'Datanalyze/css/reports.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- é é¢æ¨™é¡Œ -->
    <h1 class="page-title">å ±è¡¨ç”Ÿæˆå™¨</h1>
    
    <!-- å°èˆªæ¬„ -->
    <div class="dashboard-nav">
        <a href="{% url 'datanalyze:dashboard' %}" class="nav-link">å„€è¡¨æ¿</a>
        <a href="{% url 'datanalyze:data_analysis' %}" class="nav-link">è©³ç´°åˆ†æ</a>
        <a href="{% url 'datanalyze:reports' %}" class="nav-link active">å ±è¡¨ç”Ÿæˆ</a>
    </div>
    
    <!-- å ±è¡¨é¡å‹é¸æ“‡ -->
    <div class="card">
        <h3 class="section-title">é¸æ“‡å ±è¡¨é¡å‹</h3>
        <div class="row">
            <div class="col-md-3">
                <div class="report-type-card" data-report="user">
                    <div class="report-icon">ğŸ‘¥</div>
                    <h4>ç”¨æˆ¶å ±è¡¨</h4>
                    <p>ç”¨æˆ¶è¨»å†Šã€æ´»èºåº¦ã€è¡Œç‚ºåˆ†æ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="report-type-card" data-report="transaction">
                    <div class="report-icon">ğŸ’°</div>
                    <h4>äº¤æ˜“å ±è¡¨</h4>
                    <p>æ”¶å…¥ã€æ”¯å‡ºã€è½‰æ›ç‡åˆ†æ</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="report-type-card" data-report="performance">
                    <div class="report-icon">ğŸ“Š</div>
                    <h4>æ€§èƒ½å ±è¡¨</h4>
                    <p>ç³»çµ±æ€§èƒ½ã€éŸ¿æ‡‰æ™‚é–“ã€éŒ¯èª¤ç‡</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="report-type-card" data-report="custom">
                    <div class="report-icon">âš™ï¸</div>
                    <h4>è‡ªå®šç¾©å ±è¡¨</h4>
                    <p>æ ¹æ“šéœ€æ±‚å‰µå»ºå€‹æ€§åŒ–å ±è¡¨</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å ±è¡¨é…ç½® -->
    <div class="card" id="reportConfig" style="display: none;">
        <h3 class="section-title">å ±è¡¨é…ç½®</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">å ±è¡¨åç¨±</label>
                    <input type="text" class="form-control" id="reportName" placeholder="è¼¸å…¥å ±è¡¨åç¨±">
                </div>
                <div class="form-group">
                    <label class="form-label">æ™‚é–“ç¯„åœ</label>
                    <select class="form-control" id="reportTimeRange">
                        <option value="today">ä»Šå¤©</option>
                        <option value="yesterday">æ˜¨å¤©</option>
                        <option value="week">æœ¬é€±</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="quarter">æœ¬å­£åº¦</option>
                        <option value="year">æœ¬å¹´</option>
                        <option value="custom">è‡ªå®šç¾©</option>
                    </select>
                </div>
                <div class="form-group" id="customDateRange" style="display: none;">
                    <label class="form-label">è‡ªå®šç¾©æ—¥æœŸç¯„åœ</label>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-6">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">æ•¸æ“šç²’åº¦</label>
                    <select class="form-control" id="dataGranularity">
                        <option value="hourly">æ¯å°æ™‚</option>
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="monthly">æ¯æœˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">åŒ…å«åœ–è¡¨</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" value="line" checked> æŠ˜ç·šåœ–</label>
                        <label><input type="checkbox" value="bar" checked> æŸ±ç‹€åœ–</label>
                        <label><input type="checkbox" value="pie"> é¤…åœ–</label>
                        <label><input type="checkbox" value="table" checked> æ•¸æ“šè¡¨</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å°å‡ºæ ¼å¼</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" value="pdf" checked> PDF</label>
                        <label><input type="checkbox" value="excel"> Excel</label>
                        <label><input type="checkbox" value="csv"> CSV</label>
                        <label><input type="checkbox" value="html"> HTML</label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é«˜ç´šé¸é … -->
        <div class="advanced-options" style="margin-top: 20px;">
            <h4>é«˜ç´šé¸é …</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç¯©é¸æ¢ä»¶</label>
                        <div class="filter-conditions">
                            <div class="filter-row">
                                <select class="form-control filter-field">
                                    <option value="">é¸æ“‡æ¬„ä½</option>
                                    <option value="user_id">ç”¨æˆ¶ID</option>
                                    <option value="status">ç‹€æ…‹</option>
                                    <option value="category">é¡åˆ¥</option>
                                </select>
                                <select class="form-control filter-operator">
                                    <option value="equals">ç­‰æ–¼</option>
                                    <option value="contains">åŒ…å«</option>
                                    <option value="greater">å¤§æ–¼</option>
                                    <option value="less">å°æ–¼</option>
                                </select>
                                <input type="text" class="form-control filter-value" placeholder="å€¼">
                                <button class="btn btn-danger remove-filter">ç§»é™¤</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="addFilter">æ·»åŠ ç¯©é¸æ¢ä»¶</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">æ’åºè¦å‰‡</label>
                        <div class="sort-rules">
                            <div class="sort-row">
                                <select class="form-control sort-field">
                                    <option value="">é¸æ“‡æ¬„ä½</option>
                                    <option value="date">æ—¥æœŸ</option>
                                    <option value="amount">é‡‘é¡</option>
                                    <option value="count">æ•¸é‡</option>
                                </select>
                                <select class="form-control sort-direction">
                                    <option value="asc">å‡åº</option>
                                    <option value="desc">é™åº</option>
                                </select>
                                <button class="btn btn-danger remove-sort">ç§»é™¤</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="addSort">æ·»åŠ æ’åºè¦å‰‡</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="row" style="margin-top: 30px;">
            <div class="col-md-6">
                <button class="btn btn-primary" id="previewReport">é è¦½å ±è¡¨</button>
                <button class="btn btn-success" id="generateReport">ç”Ÿæˆå ±è¡¨</button>
            </div>
            <div class="col-md-6 text-right">
                <button class="btn btn-secondary" id="saveTemplate">ä¿å­˜æ¨¡æ¿</button>
                <button class="btn btn-warning" id="loadTemplate">è¼‰å…¥æ¨¡æ¿</button>
            </div>
        </div>
    </div>
    
    <!-- å ±è¡¨é è¦½ -->
    <div class="card" id="reportPreview" style="display: none;">
        <h3 class="section-title">å ±è¡¨é è¦½</h3>
        <div class="report-preview-content">
            <div class="report-header">
                <h2 id="previewTitle">å ±è¡¨æ¨™é¡Œ</h2>
                <p id="previewDateRange">æ—¥æœŸç¯„åœ</p>
            </div>
            <div class="report-summary">
                <div class="row">
                    <div class="col-md-3">
                        <div class="summary-item">
                            <div class="summary-number" id="previewTotal">0</div>
                            <div class="summary-label">ç¸½æ•¸</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-item">
                            <div class="summary-number" id="previewAverage">0</div>
                            <div class="summary-label">å¹³å‡å€¼</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-item">
                            <div class="summary-number" id="previewMax">0</div>
                            <div class="summary-label">æœ€å¤§å€¼</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="summary-item">
                            <div class="summary-number" id="previewMin">0</div>
                            <div class="summary-label">æœ€å°å€¼</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="report-charts">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h4>è¶¨å‹¢åœ–</h4>
                            <canvas id="previewChart" width="300" height="200"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h4>åˆ†å¸ƒåœ–</h4>
                            <canvas id="previewDistributionChart" width="300" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="report-table">
                <h4>è©³ç´°æ•¸æ“š</h4>
                <div class="table-responsive">
                    <table class="data-table" id="previewTable">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ•¸å€¼</th>
                                <th>è®ŠåŒ–</th>
                                <th>ç™¾åˆ†æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- é è¦½æ•¸æ“šå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å ±è¡¨æ­·å² -->
    <div class="card">
        <h3 class="section-title">å ±è¡¨æ­·å²</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>å ±è¡¨åç¨±</th>
                        <th>é¡å‹</th>
                        <th>ç”Ÿæˆæ™‚é–“</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ç”¨æˆ¶æ´»èºåº¦å ±è¡¨</td>
                        <td>ç”¨æˆ¶å ±è¡¨</td>
                        <td>2024-01-15 14:30</td>
                        <td><span class="status-completed">å·²å®Œæˆ</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary">ä¸‹è¼‰</button>
                            <button class="btn btn-sm btn-danger">åˆªé™¤</button>
                        </td>
                    </tr>
                    <tr>
                        <td>æ”¶å…¥åˆ†æå ±è¡¨</td>
                        <td>äº¤æ˜“å ±è¡¨</td>
                        <td>2024-01-14 09:15</td>
                        <td><span class="status-completed">å·²å®Œæˆ</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary">ä¸‹è¼‰</button>
                            <button class="btn btn-sm btn-danger">åˆªé™¤</button>
                        </td>
                    </tr>
                    <tr>
                        <td>ç³»çµ±æ€§èƒ½å ±è¡¨</td>
                        <td>æ€§èƒ½å ±è¡¨</td>
                        <td>2024-01-13 16:45</td>
                        <td><span class="status-processing">è™•ç†ä¸­</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" disabled>ç­‰å¾…ä¸­</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
<div class="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 1000;">
    ç”Ÿæˆå ±è¡¨ä¸­...
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'Datanalyze/js/main.js' %}"></script>
<script>
    // å ±è¡¨é é¢ç‰¹å®šçš„ JavaScript ä»£ç¢¼
    document.addEventListener('DOMContentLoaded', function() {
        // å ±è¡¨é¡å‹é¸æ“‡
        const reportTypeCards = document.querySelectorAll('.report-type-card');
        const reportConfig = document.getElementById('reportConfig');
        
        reportTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                const reportType = this.getAttribute('data-report');
                showReportConfig(reportType);
            });
        });
        
        // è‡ªå®šç¾©æ—¥æœŸç¯„åœé¡¯ç¤º/éš±è—
        const timeRangeSelect = document.getElementById('reportTimeRange');
        const customDateRange = document.getElementById('customDateRange');
        
        timeRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });
        
        // æ·»åŠ ç¯©é¸æ¢ä»¶
        document.getElementById('addFilter').addEventListener('click', function() {
            addFilterRow();
        });
        
        // æ·»åŠ æ’åºè¦å‰‡
        document.getElementById('addSort').addEventListener('click', function() {
            addSortRow();
        });
        
        // é è¦½å ±è¡¨
        document.getElementById('previewReport').addEventListener('click', function() {
            previewReport();
        });
        
        // ç”Ÿæˆå ±è¡¨
        document.getElementById('generateReport').addEventListener('click', function() {
            generateReport();
        });
    });
    
    // é¡¯ç¤ºå ±è¡¨é…ç½®
    function showReportConfig(reportType) {
        document.getElementById('reportConfig').style.display = 'block';
        
        // æ ¹æ“šå ±è¡¨é¡å‹è¨­ç½®é è¨­å€¼
        switch(reportType) {
            case 'user':
                document.getElementById('reportName').value = 'ç”¨æˆ¶åˆ†æå ±è¡¨';
                break;
            case 'transaction':
                document.getElementById('reportName').value = 'äº¤æ˜“åˆ†æå ±è¡¨';
                break;
            case 'performance':
                document.getElementById('reportName').value = 'æ€§èƒ½åˆ†æå ±è¡¨';
                break;
            case 'custom':
                document.getElementById('reportName').value = 'è‡ªå®šç¾©å ±è¡¨';
                break;
        }
        
        // æ»¾å‹•åˆ°é…ç½®å€åŸŸ
        document.getElementById('reportConfig').scrollIntoView({ behavior: 'smooth' });
    }
    
    // æ·»åŠ ç¯©é¸è¡Œ
    function addFilterRow() {
        const filterConditions = document.querySelector('.filter-conditions');
        const newRow = document.createElement('div');
        newRow.className = 'filter-row';
        newRow.innerHTML = `
            <select class="form-control filter-field">
                <option value="">é¸æ“‡æ¬„ä½</option>
                <option value="user_id">ç”¨æˆ¶ID</option>
                <option value="status">ç‹€æ…‹</option>
                <option value="category">é¡åˆ¥</option>
            </select>
            <select class="form-control filter-operator">
                <option value="equals">ç­‰æ–¼</option>
                <option value="contains">åŒ…å«</option>
                <option value="greater">å¤§æ–¼</option>
                <option value="less">å°æ–¼</option>
            </select>
            <input type="text" class="form-control filter-value" placeholder="å€¼">
            <button class="btn btn-danger remove-filter">ç§»é™¤</button>
        `;
        
        filterConditions.appendChild(newRow);
        
        // ç¶å®šç§»é™¤æŒ‰éˆ•äº‹ä»¶
        newRow.querySelector('.remove-filter').addEventListener('click', function() {
            filterConditions.removeChild(newRow);
        });
    }
    
    // æ·»åŠ æ’åºè¡Œ
    function addSortRow() {
        const sortRules = document.querySelector('.sort-rules');
        const newRow = document.createElement('div');
        newRow.className = 'sort-row';
        newRow.innerHTML = `
            <select class="form-control sort-field">
                <option value="">é¸æ“‡æ¬„ä½</option>
                <option value="date">æ—¥æœŸ</option>
                <option value="amount">é‡‘é¡</option>
                <option value="count">æ•¸é‡</option>
            </select>
            <select class="form-control sort-direction">
                <option value="asc">å‡åº</option>
                <option value="desc">é™åº</option>
            </select>
            <button class="btn btn-danger remove-sort">ç§»é™¤</button>
        `;
        
        sortRules.appendChild(newRow);
        
        // ç¶å®šç§»é™¤æŒ‰éˆ•äº‹ä»¶
        newRow.querySelector('.remove-sort').addEventListener('click', function() {
            sortRules.removeChild(newRow);
        });
    }
    
    // é è¦½å ±è¡¨
    function previewReport() {
        const reportName = document.getElementById('reportName').value;
        const timeRange = document.getElementById('reportTimeRange').value;
        
        if (!reportName) {
            showNotification('è«‹è¼¸å…¥å ±è¡¨åç¨±', 'error');
            return;
        }
        
        // é¡¯ç¤ºé è¦½å€åŸŸ
        document.getElementById('reportPreview').style.display = 'block';
        
        // æ›´æ–°é è¦½å…§å®¹
        document.getElementById('previewTitle').textContent = reportName;
        document.getElementById('previewDateRange').textContent = `æ™‚é–“ç¯„åœ: ${timeRange}`;
        
        // æ¨¡æ“¬æ•¸æ“š
        document.getElementById('previewTotal').textContent = '1,234';
        document.getElementById('previewAverage').textContent = '123.4';
        document.getElementById('previewMax').textContent = '456';
        document.getElementById('previewMin').textContent = '12';
        
        // æ»¾å‹•åˆ°é è¦½å€åŸŸ
        document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
    }
    
    // ç”Ÿæˆå ±è¡¨
    function generateReport() {
        const reportName = document.getElementById('reportName').value;
        
        if (!reportName) {
            showNotification('è«‹è¼¸å…¥å ±è¡¨åç¨±', 'error');
            return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.querySelector('.loading').style.display = 'block';
        
        // æ¨¡æ“¬å ±è¡¨ç”Ÿæˆéç¨‹
        setTimeout(() => {
            document.querySelector('.loading').style.display = 'none';
            showNotification('å ±è¡¨ç”Ÿæˆå®Œæˆï¼', 'success');
            
            // é€™è£¡å¯ä»¥å¯¦ç¾å¯¦éš›çš„å ±è¡¨ç”Ÿæˆé‚è¼¯
            console.log('å ±è¡¨ç”Ÿæˆå®Œæˆ:', reportName);
        }, 3000);
    }
</script>
{% endblock %}
